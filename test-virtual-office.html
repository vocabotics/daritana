<!DOCTYPE html>
<html>
<head>
    <title>Virtual Office Test</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .message { background: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .log { background: #333; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 10px; width: 300px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Virtual Office WebSocket Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <h2>Test Controls</h2>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="changeRoom('design-studio')">Join Design Studio</button>
        <button onclick="changeRoom('meeting-room-1')">Join Meeting Room</button>
        <button onclick="updateStatus('busy')">Set Busy</button>
        <button onclick="updateStatus('online')">Set Online</button>
    </div>
    
    <div>
        <h2>Send Message</h2>
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div>
        <h2>Event Log</h2>
        <div id="log" class="log"></div>
    </div>
    
    <div>
        <h2>Team Members</h2>
        <div id="teamMembers"></div>
    </div>
    
    <div>
        <h2>Messages</h2>
        <div id="messages"></div>
    </div>

    <script>
        let socket = null;
        const API_BASE = 'http://localhost:7001';
        let authToken = null;
        
        function log(message, data) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<div>[${timestamp}] ${message}${data ? ': ' + JSON.stringify(data, null, 2) : ''}</div>` + logDiv.innerHTML;
        }
        
        async function connect() {
            try {
                // First login to get token
                const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'password123'
                    })
                });
                
                const loginData = await loginResponse.json();
                authToken = loginData.token;
                
                if (!authToken) {
                    log('ERROR: Failed to get auth token');
                    return;
                }
                
                log('Login successful, got token');
                
                // Connect to Socket.IO
                socket = io(API_BASE, {
                    auth: { token: authToken },
                    transports: ['websocket', 'polling']
                });
                
                // Setup event listeners
                socket.on('connect', () => {
                    log('âœ… Connected to WebSocket');
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = 'Connected';
                });
                
                socket.on('disconnect', () => {
                    log('âŒ Disconnected from WebSocket');
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = 'Disconnected';
                });
                
                socket.on('error', (error) => {
                    log('ERROR', error);
                });
                
                socket.on('virtual-office:connected', (data) => {
                    log('ðŸ¢ Virtual Office Connected', data);
                    updateTeamMembers(data.teamMembers || []);
                    updateMessages(data.messages || []);
                });
                
                socket.on('virtual-office:user-joined', (user) => {
                    log('ðŸ‘¤ User joined', user);
                });
                
                socket.on('virtual-office:new-message', (message) => {
                    log('ðŸ’¬ New message', message);
                    addMessage(message);
                });
                
                socket.on('virtual-office:room-changed', (data) => {
                    log('ðŸšª Room changed', data);
                    updateMessages(data.messages || []);
                });
                
                socket.on('virtual-office:presence-updated', (data) => {
                    log('ðŸ‘ï¸ Presence updated', data);
                });
                
            } catch (error) {
                log('ERROR connecting', error.message);
            }
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }
        
        function changeRoom(roomId) {
            if (!socket) {
                log('Not connected');
                return;
            }
            socket.emit('virtual-office:change-room', roomId);
            log('Changing room to ' + roomId);
        }
        
        function updateStatus(status) {
            if (!socket) {
                log('Not connected');
                return;
            }
            socket.emit('virtual-office:update-status', { status });
            log('Updating status to ' + status);
        }
        
        function sendMessage() {
            if (!socket) {
                log('Not connected');
                return;
            }
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;
            
            socket.emit('virtual-office:send-message', { content });
            log('Sending message: ' + content);
            input.value = '';
        }
        
        function updateTeamMembers(members) {
            const div = document.getElementById('teamMembers');
            div.innerHTML = members.map(m => 
                `<div class="message">
                    <strong>${m.name}</strong> (${m.email}) - 
                    <span style="color: ${m.status === 'online' ? 'green' : 'gray'}">${m.status}</span>
                </div>`
            ).join('');
        }
        
        function updateMessages(messages) {
            const div = document.getElementById('messages');
            div.innerHTML = messages.map(m => 
                `<div class="message">
                    <strong>${m.senderName}:</strong> ${m.content}
                    <small>(${new Date(m.timestamp).toLocaleTimeString()})</small>
                </div>`
            ).join('');
        }
        
        function addMessage(message) {
            const div = document.getElementById('messages');
            div.innerHTML = `<div class="message">
                <strong>${message.senderName}:</strong> ${message.content}
                <small>(${new Date(message.timestamp).toLocaleTimeString()})</small>
            </div>` + div.innerHTML;
        }
        
        // Allow Enter key to send messages
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>