// Backup of original server.ts before enhancement
import express, { Express } from 'express'
import cors from 'cors'
import helmet from 'helmet'
import dotenv from 'dotenv'
import { createServer } from 'http'
import { Server as SocketIOServer } from 'socket.io'
import path from 'path'
import { PrismaClient } from '@prisma/client'
import rateLimit from 'express-rate-limit'

// Import routers
import multiTenantAuthRouter from './routes/multi-tenant-auth'
import documentsRouter from './routes/documents'
import reviewsRouter from './routes/reviews'
import hrRouter from './routes/hr'
import learningRouter from './routes/learning'
import organizationRouter from './routes/organization.routes'
import systemAdminRouter from './routes/system-admin.routes'
import communityRouter from './routes/community.routes'
import enterpriseRouter from './routes/enterprise.routes'
import projectRouter from './routes/project.routes'
import tasksRouter from './routes/tasks'
import studioRouter from './routes/studio'
import permissionsRouter from './routes/permissions'

// Import middleware
import { authenticate } from './middleware/auth'

// Import Socket handlers
import { setupSocketHandlers } from './sockets'
import { setupWebRTCSignaling } from './sockets/webrtc'

// Load environment variables
dotenv.config()

// Initialize Prisma
export const prisma = new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
})

const app: Express = express()
const httpServer = createServer(app)

// Initialize Socket.IO
const io = new SocketIOServer(httpServer, {
  cors: {
    origin: process.env.FRONTEND_URL || 'http://localhost:5174',
    credentials: true,
  },
  transports: ['websocket', 'polling'],
})

// Port configuration
const PORT = process.env.PORT || 8080
const NODE_ENV = process.env.NODE_ENV || 'development'

// Security middleware
app.use(helmet({
  crossOriginResourcePolicy: { policy: 'cross-origin' },
  contentSecurityPolicy: false,
}))

// Parse CORS origins from environment variable
const corsOrigins = process.env.CORS_ORIGIN 
  ? process.env.CORS_ORIGIN.split(',').map(origin => origin.trim())
  : ['http://localhost:5174', 'http://127.0.0.1:5174'];

app.use(cors({
  origin: (origin, callback) => {
    // Allow requests with no origin (like mobile apps)
    if (!origin) return callback(null, true);
    
    if (corsOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
}))

// Body parsing middleware
app.use(express.json({ limit: '50mb' }))
app.use(express.urlencoded({ extended: true, limit: '50mb' }))

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP, please try again later.',
})

// Apply rate limiting to API routes
app.use('/api', limiter)

// Static files for uploads
app.use('/uploads', express.static(path.join(__dirname, '..', 'uploads')))

// Root endpoint
app.get('/', (req, res) => {
  res.json({ 
    message: 'Daritana Backend API',
    version: '1.0.0',
    status: 'running',
    documentation: process.env.NODE_ENV === 'development' ? `http://localhost:${PORT}/api-docs` : undefined
  })
})

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

// API Routes
app.use('/api/auth', multiTenantAuthRouter)
app.use('/api/organizations', organizationRouter)
app.use('/api/system', systemAdminRouter)
app.use('/api/projects', projectRouter)
app.use('/api/tasks', authenticate, tasksRouter)
app.use('/api/studio', authenticate, studioRouter)
app.use('/api/documents', authenticate, documentsRouter)
app.use('/api/reviews', authenticate, reviewsRouter)
app.use('/api/hr', authenticate, hrRouter)
app.use('/api/learning', learningRouter)
app.use('/api/community', communityRouter)
app.use('/api/enterprise', enterpriseRouter)
app.use('/api/permissions', authenticate, permissionsRouter)

// Support old v1 endpoints for backwards compatibility
app.use('/api/v1/auth', multiTenantAuthRouter)
app.use('/api/v1/projects', projectRouter)
app.use('/api/v1/tasks', authenticate, tasksRouter)
app.use('/api/v1/documents', authenticate, documentsRouter)

// Socket.IO handlers
setupSocketHandlers(io)
setupWebRTCSignaling(io)

// Error handling middleware
app.use((err: any, req: any, res: any, next: any) => {
  console.error(err.stack)
  res.status(err.status || 500).json({
    error: err.message || 'Internal server error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),
  })
})

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Not found' })
})

// Graceful shutdown
process.on('SIGTERM', async () => {
  console.log('SIGTERM signal received: closing HTTP server')
  httpServer.close(() => {
    console.log('HTTP server closed')
  })
  await prisma.$disconnect()
  process.exit(0)
})

process.on('SIGINT', async () => {
  console.log('SIGINT signal received: closing HTTP server')
  httpServer.close(() => {
    console.log('HTTP server closed')
  })
  await prisma.$disconnect()
  process.exit(0)
})

// Start server
httpServer.listen(PORT, () => {
  console.log(`ðŸš€ Server running on http://localhost:${PORT}`)
  console.log(`ðŸ”Œ WebSocket server running on ws://localhost:${PORT}`)
  console.log(`ðŸ“š API documentation available at http://localhost:${PORT}/api-docs`)
})

export { app, io }